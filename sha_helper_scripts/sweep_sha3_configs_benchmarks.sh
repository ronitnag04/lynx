#!/usr/bin/env bash

# Sweep over Sha3Rocket configs and benchmarks using Verilator
#
# This script:
#   - cd's to the chipyard Verilator sims directory
#   - iterates over a list of benchmarks (edit BENCHMARKS below)
#   - iterates over all Sha3Rocket* configs generated by gen_sha3_sweep_configs.py
#   - runs: make run-binary CONFIG=<config> BINARY=<benchmark>
#
# Usage:
#   ./scripts/sweep_sha3_configs.sh
#
# Notes:
#   - BENCHMARKS is intentionally defined here so you can manually
#     choose which binaries to sweep over.
#   - CONFIG names follow the pattern from gen_sha3_sweep_configs.py:
#       Sha3RocketW{w}S{s}Fm{0|1}Bs{0|1}K{0|1}

set -euo pipefail

# Adjust this if you move the script
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

K0_BENCHMARKS=(
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-150-k0.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-256-k0.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-512-k0.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-1024-k0.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-1600-k0.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-2048-k0.riscv"
  # "${REPO_ROOT}/generators/sha3/software/tests/bare/sha3-rocc.riscv"
)

K1_BENCHMARKS=(
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-150-k1.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-256-k1.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-512-k1.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-1024-k1.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-1600-k1.riscv"
  "${REPO_ROOT}/generators/sha3/software/tests/benchmarks/sha3-rocc-benchmark-2048-k1.riscv"
)

# ---------------------------------------------------------------------------
# Config generation: mirror gen_sha3_sweep_configs.py
#   WIDTHS = [64]
#   STAGES = [1, 2, 3, 4]
#   FASTM  = [False, True]  -> Fm0 / Fm1
#   BUFFS  = [False, True]  -> Bs0 / Bs1
#   KECCAK = [False, True]  -> K0  / K1
# ---------------------------------------------------------------------------
WIDTHS=(64)
STAGES=(1 2 4)
BOOLS=(0 1)  # used for Fm, Bs, K

# Build the list of config names
CONFIGS=()
for w in "${WIDTHS[@]}"; do
  for s in "${STAGES[@]}"; do
    for fm in "${BOOLS[@]}"; do
      for bs in "${BOOLS[@]}"; do
        for k in "${BOOLS[@]}"; do
          CONFIGS+=("Sha3RocketW${w}S${s}Fm${fm}Bs${bs}K${k}")
        done
      done
    done
  done
done

# Go to Verilator sims directory
cd "${REPO_ROOT}/sims/verilator"

# ---------------------------------------------------------------------------
# Phase 1: Build all configs in parallel (make CONFIG=X -j8)
# ---------------------------------------------------------------------------
echo "============================================================"
echo "Building simulators for all Sha3Rocket configs (in parallel)..."
echo "============================================================"

pids=()
successful_configs=()
failed_configs=()
build_failed=0

for cfg in "${CONFIGS[@]}"; do
  echo "[BUILD] CONFIG=${cfg}"
  # Use default make target with CONFIG set, parallelized via -j8
  ( make CONFIG="${cfg}" -j8 ) &
  pids+=("$!")
done

for i in "${!pids[@]}"; do
  pid="${pids[$i]}"
  cfg="${CONFIGS[$i]}"
  if wait "${pid}"; then
    successful_configs+=("${cfg}")
  else
    echo "[ERROR] Build failed for CONFIG=${cfg}" >&2
    failed_configs+=("${cfg}")
    build_failed=1
  fi
done

if [[ "${#successful_configs[@]}" -eq 0 ]]; then
  echo "[ERROR] All CONFIG builds failed; nothing to benchmark." >&2
  exit 1
fi

if [[ "${build_failed}" -ne 0 ]]; then
  echo "[WARN] One or more CONFIG builds failed; benchmarks will run only on successfully built configs." >&2
fi

# ---------------------------------------------------------------------------
# Phase 2: Run all benchmark binaries for each *successfully built* config
#          config parallel, benchmark parallel
# ---------------------------------------------------------------------------
echo "============================================================"
echo "Running all benchmarks for all configs (in parallel)..."
echo "============================================================"

failed_runs=()
successful_runs=()
benchmark_pids=()
benchmark_configs=()
benchmark_binaries=()

# Start all benchmark runs in parallel
for cfg in "${successful_configs[@]}"; do
  # Select appropriate benchmarks based on config type
  if [[ "${cfg}" == *"K0"* ]]; then
    BENCHMARKS=("${K0_BENCHMARKS[@]}")
  else
    BENCHMARKS=("${K1_BENCHMARKS[@]}")
  fi
  for bin in "${BENCHMARKS[@]}"; do
    echo "[BENCHMARK] Starting CONFIG=${cfg} BINARY=${bin}"
    ( make run-binary CONFIG="${cfg}" BINARY="${bin}" ) &
    benchmark_pids+=("$!")
    benchmark_configs+=("${cfg}")
    benchmark_binaries+=("${bin}")
  done
done

# Wait for all benchmark runs to complete and collect results
for i in "${!benchmark_pids[@]}"; do
  pid="${benchmark_pids[$i]}"
  cfg="${benchmark_configs[$i]}"
  bin="${benchmark_binaries[$i]}"
  if wait "${pid}"; then
    echo "[SUCCESS] CONFIG=${cfg} BINARY=${bin}"
    successful_runs+=("CONFIG=${cfg} BINARY=${bin}")
  else
    echo "[ERROR] Failed: CONFIG=${cfg} BINARY=${bin}" >&2
    failed_runs+=("CONFIG=${cfg} BINARY=${bin}")
  fi
done

# ---------------------------------------------------------------------------
# Phase 3: Print summary of results, which configs and benchmarks failed
# ---------------------------------------------------------------------------

# Print the CONFIGS that failed to build if any
if [[ "${build_failed}" -ne 0 ]]; then
  echo "============================================================"
  echo "SUMMARY: The following CONFIGS failed to build:"
  echo "============================================================"
  for config in "${failed_configs[@]}"; do
    echo "  ${config}"
  done
fi

# Print the benchmark runs that failed if any
if [[ "${#failed_runs[@]}" -gt 0 ]]; then
  echo "============================================================"
  echo "SUMMARY: The following benchmark runs failed:"
  echo "============================================================"
  for failed in "${failed_runs[@]}"; do
    echo "  ${failed}"
  done
fi

# Print the benchmark runs that succeeded if any
if [[ "${#successful_runs[@]}" -gt 0 ]]; then
  echo "============================================================"
  echo "SUMMARY: The following benchmark runs succeeded:"
  echo "============================================================"
  for successful in "${successful_runs[@]}"; do
    echo "  ${successful}"
  done
fi

if [[ "${#failed_runs[@]}" -gt 0 ]] || [[ "${build_failed}" -ne 0 ]]; then
  exit 1
fi

exit 0